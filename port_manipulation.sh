#!/bin/bash

function show_help {
    echo "usage:        Close ports based on user input"
    echo " "
    echo "-m: mode      close / list"
    echo "-p port:      Port to close (insert multiple ports with comma; e.g. 80,443,8080)"
}

PORT=""
MODE=""

while getopts "m:p:h:" opt; do
    case $opt in
    m)
        MODE=$OPTARG
        ;;
    p)
        PORT=$OPTARG
        ;;
    h)
        show_help
        exit 0
        ;;
    \?)
        show_help
        exit 0
        ;;
    esac
done

echo "Ports to close: $PORT"
echo " "

if [[ -z $MODE ]]; then
    echo "Please select a mode!"
    exit 1
fi

if [[ $MODE == "close" ]]; then
    if [[ -z $PORT ]]; then
        echo "Please input port to close!"
        exit 1
    fi
    echo "Closing ports $PORT";
    sudo iptables -A INPUT -p tcp --dport "$PORT" -j REJECT
    sudo /sbin/iptables-save
elif [[ $MODE == "open" ]]; then
    if [[ -z $PORT ]]; then
        echo "Please input port to open!"
        exit 1
    fi
    echo "Opening ports $PORT";
    sudo iptables -F INPUT
    sudo /sbin/iptables-save
elif [[ $MODE == "list" ]]; then
    echo "Listing ports";
    ss -tulnp | grep LISTEN;
    exit 0;
elif [[ $MODE == "iptables" ]]; then
    echo "Listing iptables";
    iptables -L --line-numbers;
    exit 0;
else
    echo "Please select a valid mode!";
    exit 1;
fi